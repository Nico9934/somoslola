generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      UserRole @default(CUSTOMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  carts     Cart[]
  orders    Order[]
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
}

model Category {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  products Product[]
}

model Brand {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  slug     String    @unique
  logo     String?
  products Product[]
}

model Product {
  id          Int                @id @default(autoincrement())
  name        String
  description String?
  categoryId  Int
  brandId     Int?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  category    Category           @relation(fields: [categoryId], references: [id])
  brand       Brand?             @relation(fields: [brandId], references: [id])
  images      ProductImage[]
  variants    ProductVariant[]
  attributes  ProductAttribute[]
}

model ProductVariant {
  id              Int                      @id @default(autoincrement())
  productId       Int
  sku             String                   @unique
  salePrice       Float                    // Precio de venta actual
  promotionPrice  Float?                   // Precio de promoción (opcional)
  cost            Float?                   // Costo de la variante
  isActive        Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  cartItems       CartItem[]
  orderItems      OrderItem[]
  product         Product                  @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeValues VariantAttributeValue[]
  stock           Stock?                   // Relación uno a uno con Stock
  images          VariantImage[]           // Imágenes específicas de la variante
}

model Stock {
  id            Int            @id @default(autoincrement())
  variantId     Int            @unique
  quantity      Int            @default(0)      // Stock total
  reservedQty   Int            @default(0)      // Cantidad reservada en carritos/pedidos pendientes
  lowStockAlert Int?                            // Alerta de stock bajo
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  variant       ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@index([variantId])
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  url       String
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model VariantImage {
  id        Int            @id @default(autoincrement())
  url       String
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@index([variantId])
}

model Cart {
  id        String     @id @default(uuid())
  userId    Int?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User?      @relation(fields: [userId], references: [id])
  items     CartItem[]
}

/// *
///  * CartItem representa una reserva temporal de stock.
///  * Al agregar al carrito => se descuenta stock.
///  * Si expiresAt pasa => se libera stock con cron.
model CartItem {
  id         Int            @id @default(autoincrement())
  cartId     String
  variantId  Int
  quantity   Int
  reservedAt DateTime       @default(now())
  expiresAt  DateTime
  cart       Cart           @relation(fields: [cartId], references: [id])
  variant    ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId])
}

model Order {
  id                 Int         @id @default(autoincrement())
  userId             Int?
  email              String
  total              Float
  status             OrderStatus @default(PENDING)
  
  // Datos del cliente
  customerName       String
  customerPhone      String
  
  // Datos de envío
  shippingAddress       String
  shippingNeighborhood  String? // Barrio (opcional)
  shippingCity          String
  shippingState         String
  shippingPostalCode    String
  shippingCost          Float   @default(0)
  
  // Método de pago
  paymentMethod      PaymentMethod
  paymentId          String?       // ID del pago en Mercado Pago
  paymentStatus      String?       // Estado del pago: approved, pending, rejected
  paymentProof       String?       // URL del comprobante de transferencia (solo para TRANSFER)
  
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  user               User?       @relation(fields: [userId], references: [id])
  items              OrderItem[]
}

model OrderItem {
  id           Int            @id @default(autoincrement())
  orderId      Int
  variantId    Int?           // Opcional por si se elimina la variante
  quantity     Int
  price        Float          // Precio en el momento de la compra
  
  // Snapshot del producto en el momento de la compra
  productName  String         // Nombre del producto
  variantSku   String         // SKU de la variante
  imageUrl     String?        // URL de la imagen principal
  attributes   Json?          // Atributos de la variante (ej: {"Color": "Rojo", "Talle": "M"})
  
  order        Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant      ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
}

model ShippingZone {
  id       Int     @id @default(autoincrement())
  name     String
  cpStart  Int?    @map("cp_start")
  cpEnd    Int?    @map("cp_end")
  price    Int

  @@map("ShippingZone")
}

model HeroBanner {
  id        Int      @id @default(autoincrement())
  title     String?
  subtitle  String?
  imageUrl  String
  link      String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  ADMIN
  CUSTOMER
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  SHIPPED
  COMPLETED
}

enum PaymentMethod {
  CARD
  TRANSFER
}

enum AttributeType {
  SELECT
  NUMBER
  TEXT
}

// SISTEMA DE ATRIBUTOS DINÁMICOS

model Attribute {
  id           Int                @id @default(autoincrement())
  name         String             @unique
  slug         String             @unique
  type         AttributeType      @default(SELECT)
  unit         String?
  isActive     Boolean            @default(true)
  sortOrder    Int                @default(0)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  values       AttributeValue[]
  productAttrs ProductAttribute[]
}

model AttributeValue {
  id               Int                      @id @default(autoincrement())
  attributeId      Int
  value            String
  hexColor         String?
  sortOrder        Int                      @default(0)
  isActive         Boolean                  @default(true)
  createdAt        DateTime                 @default(now())
  attribute        Attribute                @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  variantValues    VariantAttributeValue[]

  @@unique([attributeId, value])
}

model ProductAttribute {
  id          Int       @id @default(autoincrement())
  productId   Int
  attributeId Int
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  attribute   Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([productId, attributeId])
}

model VariantAttributeValue {
  id               Int            @id @default(autoincrement())
  variantId        Int
  attributeId      Int
  attributeValueId Int
  variant          ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  attributeValue   AttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)

  @@unique([variantId, attributeId])
}

model PaymentSettings {
  id                 Int      @id @default(autoincrement())
  transferDiscount   Float    @default(20) // Descuento por transferencia en porcentaje
  installmentsCount  Int      @default(3)  // Cantidad de cuotas sin interés
  installmentsActive Boolean  @default(true) // Si las cuotas están activas
  updatedAt          DateTime @updatedAt
  createdAt          DateTime @default(now())
}
